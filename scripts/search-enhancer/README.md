# EhSearchEnhancer

E-Hentai搜索页增强脚本 - 提供强大的多选、批量操作和磁链管理功能。

## ✨ 功能特性

### 🎯 选择与过滤
- ✅ **多种选择方式**
  - 单选：点击复选框
  - 范围选：Shift + 点击
  - 全选/反选：右键菜单或快捷键
  
- ✅ **条件过滤**
  - 已下载的画廊
  - 已忽略的画廊
  - 无种子的画廊
  - 种子过时的画廊

### 📤 批量操作（右键菜单）
- 🔃 **刷新操作**
  - 刷新所选画廊
  - 强制刷新所选画廊

- 🔗 **链接复制**
  - 复制磁力链接（磁链）
  - 复制种子链接（种链）

- 📥 **发送下载**
  - 统一下载对话框，支持：
    - ⬇️ 发送到 Aria2
    - 📤 发送到 AB DM（归档，需配合AB Download Manager，消耗GP）
  - 📋 查询归档信息

- 📌 **标记管理**
  - 标记所选为已下载
  - 忽略所选画廊
  - 清除标识

- 👁️ **显示管理**
  - 临时隐藏所选
  - 取消临时隐藏
  - 下载所选种子文件

### ⚙️ 单画廊快捷菜单（齿轮图标）
- 📌 标记/取消标记此画廊
- 🚫 忽略/取消忽略此画廊
- 🔃 刷新此画廊
- ⚡ 强制刷新此画廊
- 📤 发送到AB DM（归档）
- 🔄 刷新全部画廊

### 🌱 种子菜单（种子右键）
- 📌 标记/取消标记
- 🧲 复制磁链
- 🌱 复制种链
- ⬇️ 下载种子
- 🚫 忽略

### ⚙️ 高级功能
- 🔄 **自动刷新** - 打开页面时自动获取种子信息
- 👆 **鼠标悬停刷新** - 悬停画廊时自动刷新
- 🔧 **种子抓取设置**
  - 配置并发数量 **（请根据账号、网络情况，设置合适的并发数，以免被风控。）**
  - 设置缓存超时时限
  - AB DM端口配置

- 📊 **数据管理**
  - 导出/导入选择列表
  - 保存最近下载记录（最多999条）
  - 批量查询和清除标记

- 💾 **设置管理**
  - 导出脚本设置
  - 导入备份设置

## 界面预览
### 复选框和复选框右键菜单
<img width="1578" height="1336" alt="image" src="https://github.com/user-attachments/assets/69bfcd82-27cc-4a36-a199-6882bae1970d" />

### 画廊齿轮菜单
<img width="550" height="1135" alt="image" src="https://github.com/user-attachments/assets/56afb370-3c45-4171-b284-1ce96d7adc5d" />

### 种子右键菜单
<img width="303" height="370" alt="image" src="https://github.com/user-attachments/assets/4c8f55bc-8b97-4dc2-98dc-cc3dd29366ca" />

### 页面右上、右下角的提示信息和设置菜单
<img width="598" height="947" alt="image" src="https://github.com/user-attachments/assets/3110aa19-b974-49a2-b770-9bd24825ee51" />

### 发送下载（选中多类型画廊时）
<img width="778" height="1023" alt="image" src="https://github.com/user-attachments/assets/b5a74c7b-d457-4018-ad20-c06702cefe9f" />

### 批量查询/归档
![1](https://github.com/user-attachments/assets/dcb21e7e-5634-41aa-be0e-2cddb091b956)

### 最近下载
<img width="1082" height="736" alt="image" src="https://github.com/user-attachments/assets/3e0949d6-07c9-4388-8ed0-8e08af353565" />

### 画廊详情页
<img width="348" height="637" alt="image" src="https://github.com/user-attachments/assets/84904c76-5e10-46c4-8568-846b9a0a7bd9" />

## 📖 使用指南

### 基础使用

#### 1. 选择画廊
```
• 单选：点击画廊左侧的复选框
• 范围选：Shift + 点击第一个和最后一个画廊
• 全选：右键菜单 → ☑️ 全选
• 条件过滤：勾选"已下载"、"已忽略"等过滤选项
```

#### 2. 批量操作
```
• 选中画廊后在复选框上右键打开菜单
• 选择需要的操作（复制、发送、标记等）
• 或使用"其它功能"按钮快速访问菜单
```

#### 3. 快速查看功能说明
```
• 点击设置按钮（页面右上/右下角）
• 在设置菜单中点击"功能说明"按钮
• 查看各功能的详细说明
```

### 常见操作示例

#### 批量下载到Aria2
1. 选择要下载的画廊（可多选）
2. 在复选框上右键打开菜单
3. 点击"📤 发送下载"
4. 在弹出的对话框中选择"⬇️ Aria2"
5. 选择磁链或种链
6. 确认发送

#### 标记已下载的画廊
1. 选择画廊
2. 右键菜单 → "📌 标记所选"
3. 被标记的画廊会显示✓图标

#### 忽略不感兴趣的画廊
1. 选择画廊
2. 右键菜单 → "🚫 忽略所选"
3. 忽略的画廊会显示✗图标
4. 勾选"已忽略"过滤条件可在多选时排除相应画廊

### 快捷菜单

#### 右键菜单快捷入口
在任何地方右键都能快速访问：
- 复选框右键：批量操作菜单
- 种子右键：单项操作菜单

#### "其它功能"按钮
- 位置：页面右上/右下角
- 作用：快速打开批量操作菜单

#### 齿轮菜单（⚙️）
- 位置：每个画廊的缩略图下方
- 功能：单画廊的快速操作（标记、忽略、查询等）

#### 页面设置菜单
- 位置：页面右上角"设置"按钮
- 功能：配置全局功能和性能选项

## ⚙️ 页面设置说明

### 搜索页无限滚动
- **功能**：启用后，滚动到页面底部时自动加载更多结果
- **默认值**：关闭

### 开启日志
- **功能**：在浏览器控制台输出调试日志（开发用）
- **默认值**：关闭

### 自动刷新
- **功能**：打开搜索页面时，自动获取所有画廊的种子信息
- **说明**：不同于"实时刷新"，仅在页面加载时执行一次
- **默认值**：关闭

### 鼠标悬停刷新
- **功能**：鼠标悬停在画廊上时自动刷新该画廊的信息
- **需求**：需配置好刷新间隔时间
- **默认值**：开启

### 种子抓取设置
- **并发数**：同时刷新的画廊数量（1-10）
- **缓存超时**：种子信息缓存的时间限制（秒）

### AB DM端口
- **功能**：配置本地AB Download Manager的监听端口
- **默认值**：15151
- **范围**：1024-65535
- **说明**：用于发送画廊到AB DM进行归档下载（消耗GP）

### 最近下载记录上限
- **功能**：保存最近下载的画廊列表
- **范围**：1-999条
- **默认值**：100

## ⚠️ 注意事项

1. **仅适配缩略图模式**
   - 脚本仅在E-Hentai的缩略图（Thumb）模式下运行
   - 列表模式、Minimal模式等暂不支持

2. **登录要求**
   - 某些功能（如查询归档、发送到AB DM）需要登录E-Hentai账号
   - 未登录时这些功能会被禁用

3. **归档下载消耗GP**
   - 发送到AB DM（归档）会消耗账户GP
   - 请谨慎使用，确认需要后再操作

4. **缓存机制**
   - 脚本使用浏览器LocalStorage存储数据
   - 清空浏览器缓存会丢失已保存的标记和数据

5. **性能和风控考虑** ⚠️
   - **并发限制**：单页100画廊时，建议并发数不超过5
   - **风控风险**：
     - 同时启用无限滚动 + 自动刷新 + 高并发 → 易触发E-Hentai风控
     - 多个浏览器标签页同时进行批量操作 → 易触发风控
     - 被风控后请及时调整参数或降低频率
   - **建议配置**：
     - 优先选择以下其一而非同时启用：
       - 单页100画廊或更少，禁用自动刷新（仅手动悬停刷新+按需批量刷新），并发数5或以下
       - 仅启用无限滚动（手动悬停刷新）
       - 仅启用自动刷新（单页面）
       - 多页面操作时降低并发数至3以下
   - 鼠标悬停刷新用于单画廊体验，不影响整体性能

## 🔗 相关配置

### 配合Aria2使用
- 需要安装并运行 Aria2
- 确保 Aria2 RPC 服务可访问（默认 http://localhost:6800/jsonrpc）
- 可在设置中修改端口

### 配合AB DM（下载管理器）使用
- 需要安装 AB Download Manager
- 脚本会自动检测并与AB DM通信
- 在设置中配置正确的端口号

## 🐛 故障排查

### 菜单不显示
- 确保在E-Hentai搜索页上
- 尝试刷新页面
- 检查浏览器控制台是否有错误信息

### 无法发送到Aria2/AB DM
- 确保相应的下载工具正在运行
- 检查端口配置是否正确
- 尝试在浏览器控制台中查看错误信息

### 性能问题
- 减少自动刷新的并发数
- 禁用"鼠标悬停刷新"功能
- 清空浏览器缓存

### 数据丢失
- 检查是否清空了浏览器缓存
- 尝试导入之前导出的备份设置

## 🚀 安装

### 快速安装
点击直接安装：[EhSearchEnhancer.js](./EhSearchEnhancer.js)

### 手动安装
1. 安装 [Tampermonkey](https://www.tampermonkey.net/) 或 [Greasemonkey](https://www.greasespot.net/)
2. 打开脚本管理器
3. 点击"创建新脚本"或"新建脚本"
4. 复制 `EhSearchEnhancer.js` 的全部内容
5. 粘贴到编辑器
6. 保存并启用

## 🙏 致谢

参考实现和灵感来源：
- [E-Hentai & ExHentai Fade or hide viewed galleries](https://sleazyfork.org/en/scripts/36314-e-hentai-exhentai-fade-or-hide-viewed-galleries)
- [EH-UserScripts by SchneeHertz-AriaEh](https://github.com/SchneeHertz/EH-UserScripts/tree/master/AriaEh)

## 📄 许可证

MIT License - 详见项目根目录的 LICENSE 文件

## 📝 相关链接

- [更新日志](../../CHANGELOG.md)
- [安装指南](../../docs/installation-guide.md)
